<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>To Be Architect Trivia!</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
</head>

<body>
    <div id="registerForm" class="jumbotron d-block">
        <div class="container">
            <h1 class="display-4">Welcome to Trivia!</h1>
            <p class="lead">Please fill in the form below</p>
            <hr class="my-4">
            <form onsubmit="event.preventDefault();">
                <div class="form-group">
                    <label for="playerName">Name</label>
                    <input type="text" class="form-control" id="playerName" aria-describedby="playerNameHelp"
                        placeholder="Enter your name">
                    <small id="playerNameHelp" class="form-text text-muted">Other players will see your name.</small>
                </div>
                <button type="submit" class="btn btn-primary" onclick="register(this.form)">Register</button>
            </form>
        </div>
    </div>

    <div id="lobby" class="jumbotron d-none">
        <div class="container">
            <h1 class="display-4">Lobby</h1>
            <p class="lead">Wait for all players to join</p>
            <hr class="my-4">
            <ul id="playersList" class="list-group">

            </ul>
        </div>
    </div>

    <div id="question" class="jumbotron d-none">
        <div class="container">
            <h1 id="questionTitle" class="display-4"></h1>
            <p id="questionContent" class="lead"></p>
            <hr class="my-4">
            <div id="answerList" class="list-group">
                
            </div>
        </div>
    </div>

    <script>
        const ws = new WebSocket('ws://localhost:3000/ws');
        ws.onopen = (event) => {
            ws.send(JSON.stringify({
                action: "connect"
            }));
        };

        ws.onmessage = (event) => {
            const message = JSON.parse(event.data);
            const listElement = document.getElementById("playersList");
            if ("fetch" === message.action) {
                let i = 0;
                children = [];
                [...message.data].forEach((player) => {
                    const li = document.createElement("li");
                    li.classList.add("list-group-item")
                    if (i % 2 === 0) {
                        li.classList.add("list-group-item-success")
                    } else {
                        li.classList.add("list-group-item-info")
                    }
                    const playerName = document.createTextNode(player.name);
                    li.appendChild(playerName);

                    children.push(li);
                    i++;
                });
                listElement.replaceChildren(...children);
            } else if ("start" === message.action) {
                let i = 0;
                children = [];
                document.getElementById("lobby").classList.add("d-none");
                document.getElementById("lobby").classList.remove("d-block");
                document.getElementById("question").classList.add("d-block");
                document.getElementById("question").classList.remove("d-none");

                document.getElementById("questionTitle").innerText = `Question ${message.q.id}`;
                document.getElementById("questionContent").innerText = message.q.q;
                const listElement = document.getElementById("answerList");
                for (answer of message.q.a) {
                    const btn = document.createElement("button");
                    btn.classList.add("btn", "btn-lg", "btn-block");
                    btn.addEventListener('click', sendAnswer);
                    if (i % 2 === 0) {
                        btn.classList.add("btn-primary")
                    } else {
                        btn.classList.add("btn-success")
                    }
                    const playerName = document.createTextNode(answer);
                    btn.appendChild(playerName);

                    children.push(btn);
                    i++;
                }
                listElement.replaceChildren(...children);
            }
        };

        function register(form) {
            ws.send(JSON.stringify({
                name: form.playerName.value,
                action: 'register',
            }));
            document.getElementById("registerForm").classList.add("d-none");
            document.getElementById("registerForm").classList.remove("d-block");
            document.getElementById("lobby").classList.add("d-block");
            document.getElementById("lobby").classList.remove("d-none");
            ws.send(JSON.stringify({
                action: "fetch"
            }));
        }

        async function start() {
            const response = await fetch("/start");
        }

        function sendAnswer(event) {
            ws.send(JSON.stringify({
                action: "answer",
                answer: event.target.innerText
            }));
        }
    </script>
</body>

</html>